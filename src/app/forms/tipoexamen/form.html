<!-- ===== Tipos de Examen (tabla: tipoexamen) ===== -->
<div class="card shadow-sm">
  <div class="card-body">
    <h2 class="h5 mb-3 text-primary fw-semibold">ğŸ§ª Tipos de Examen</h2>

    <!-- FORMULARIO PRINCIPAL -->
    <!--  Agregado: referencia local para que @ViewChild('formRef') funcione -->
    <form #formRef="ngForm" (ngSubmit)="save()">
      <div class="row">

        <!--  CategorÃ­a del examen -->
        <div class="col-md-6 mb-2">
          <label class="form-label">CategorÃ­a</label>
          <select
            class="form-select"
            [(ngModel)]="model.id_categoria_tipo_examen"
            name="id_categoria_tipo_examen"
          >
            <option [ngValue]="null">-- Seleccione categorÃ­a --</option>
            <option *ngFor="let c of categorias" [ngValue]="c.id">
              {{ c.nombre }}
            </option>
          </select>
        </div>

        <!--  Perfil del examen -->
        <div class="col-md-6 mb-2">
          <label class="form-label">Perfil (opcional)</label>
          <select
            class="form-select"
            [(ngModel)]="model.id_perfil_examen"
            name="id_perfil_examen"
          >
            <option [ngValue]="null">-- Ninguno --</option>
            <option *ngFor="let p of perfiles" [ngValue]="p.id">
              {{ p.nombre }}
            </option>
          </select>
        </div>

        <!-- Nombre -->
        <div class="col-md-6 mb-2">
          <label class="form-label">Nombre</label>
          <input
            class="form-control"
            type="text"
            [(ngModel)]="model.nombre"
            name="nombre"
            required
          />
        </div>

        <!-- Precio base -->
        <div class="col-md-6 mb-2">
          <label class="form-label">Precio base (Q)</label>
          <input
            class="form-control"
            type="number"
            step="0.01"
            [(ngModel)]="model.precio"
            name="precio"
            required
          />
        </div>

        <!-- DescripciÃ³n -->
        <div class="col-md-12 mb-2">
          <label class="form-label">DescripciÃ³n</label>
          <input
            class="form-control"
            type="text"
            [(ngModel)]="model.descripcion"
            name="descripcion"
          />
        </div>
      </div>

      <div class="mt-2">
        <button class="btn btn-primary me-2" type="submit" [disabled]="loading">
          ğŸ’¾ Guardar
        </button>

        <!--  Cambio: ahora llama a resetForm() en lugar de reset() -->
        <button
          class="btn btn-secondary"
          type="button"
          (click)="resetForm()"
          [disabled]="loading"
        >
          ğŸ†• Nuevo
        </button>
      </div>
    </form>

    <!-- ALERTAS -->
    <div *ngIf="error" class="alert alert-danger mt-3">
      âš ï¸ {{ error }}
    </div>
    <div *ngIf="success" class="alert alert-success mt-3">
      âœ… {{ success }}
    </div>

    <hr />

    <!-- ============================ -->
    <!--  SUBMÃ“DULOS (PestaÃ±as) -->
    <!-- ============================ -->
    <div
      class="mt-4"
      *ngIf="(model?.id_tipo_examen || model?.id || model?.idTipoExamen) as tipoId"
    >
      <ul class="nav nav-tabs" id="tipoTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button
            class="nav-link active"
            id="parametros-tab"
            data-bs-toggle="tab"
            data-bs-target="#parametros"
            type="button"
            role="tab"
            aria-controls="parametros"
            aria-selected="true"
            (click)="onTabChange('parametros')"
          >
            âš™ï¸ ParÃ¡metros
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button
            class="nav-link"
            id="precios-tab"
            data-bs-toggle="tab"
            data-bs-target="#precios"
            type="button"
            role="tab"
            aria-controls="precios"
            aria-selected="false"
            (click)="onTabChange('precios')"
          >
            ğŸ’° Precios por clÃ­nica
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button
            class="nav-link"
            id="insumos-tab"
            data-bs-toggle="tab"
            data-bs-target="#insumos"
            type="button"
            role="tab"
            aria-controls="insumos"
            aria-selected="false"
            (click)="onTabChange('insumos')"
          >
            ğŸ§´ Insumos usados
          </button>
        </li>

      </ul>

  <div class="tab-content mt-3" id="tipoTabsContent">
  <!--  ParÃ¡metros -->
  <div
    class="tab-pane fade show active"
    id="parametros"
    role="tabpanel"
    aria-labelledby="parametros-tab"
  >
    <app-parametros-tipo-examen
      [idTipoExamen]="tipoId"
    ></app-parametros-tipo-examen>
  </div>

  <!--  Precios -->
  <div
    class="tab-pane fade"
    id="precios"
    role="tabpanel"
    aria-labelledby="precios-tab"
  >
    <div class="row g-2 align-items-end mb-3">
      <div class="col-md-4">
        <label class="form-label">ClÃ­nica</label>
        <select
          class="form-select"
          [(ngModel)]="precio.id_clinica"
          name="id_clinica"
        >
          <option [ngValue]="null">-- Seleccione --</option>
          <option *ngFor="let c of clinicas" [ngValue]="c.id">
            {{ c.nombre }}
          </option>
        </select>
      </div>

      <div class="col-md-3">
        <label class="form-label">Precio especial (Q)</label>
        <input
          class="form-control"
          type="number"
          step="0.01"
          [(ngModel)]="precio.precio_especial"
          name="precio_especial"
        />
      </div>

      <div class="col-md-2">
        <label class="form-label">Desde</label>
        <input
          class="form-control"
          type="date"
          [(ngModel)]="precio.vigente_desde"
          name="vigente_desde"
        />
      </div>

      <div class="col-md-2">
        <label class="form-label">Hasta</label>
        <input
          class="form-control"
          type="date"
          [(ngModel)]="precio.vigente_hasta"
          name="vigente_hasta"
        />
      </div>

      <div class="col-md-1">
        <button
          class="btn btn-success w-100"
          type="button"
          (click)="guardarPrecio()"
        >
          ğŸ’¾
        </button>
      </div>
    </div>

    <table class="table table-sm table-bordered shadow-sm">
      <thead>
        <tr>
          <th>ClÃ­nica</th>
          <th>Precio especial</th>
          <th>Desde</th>
          <th>Hasta</th>
          <th style="width: 80px">Acciones</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let p of preciosClinica">
          <td>{{ p.clinica }}</td>
          <td>
            <span class="fw-semibold text-success">
              Q{{ p.precioEspecial | number: '1.2-2' }}
            </span>
          </td>
          <td>
            {{ p.vigenteDesde ? (p.vigenteDesde | date: 'dd/MM/yyyy') : 'â€”' }}
          </td>
          <td>
            {{ p.vigenteHasta ? (p.vigenteHasta | date: 'dd/MM/yyyy') : 'â€”' }}
          </td>
          <td class="text-center">
            <button
              class="btn btn-sm btn-outline-danger"
              (click)="eliminarPrecio(p)"
            >
              ğŸ—‘ï¸
            </button>
          </td>
        </tr>

        <tr *ngIf="!preciosClinica.length">
          <td colspan="5" class="text-center text-muted py-3">
            Sin precios registrados
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!--  INSUMOS ASOCIADOS -->
<div
  class="tab-pane fade"
  id="insumos"
  role="tabpanel"
  aria-labelledby="insumos-tab"
>
  <!-- Formulario para agregar insumos -->
  <div class="row g-2 align-items-end mb-3">
    <div class="col-md-6">
      <label class="form-label">Insumo</label>
      <select
        class="form-select"
        [(ngModel)]="nuevoInsumo.id_insumo"
        name="id_insumo"
      >
        <option [ngValue]="null">-- Seleccione insumo --</option>
        <option *ngFor="let i of insumosDisponibles" [ngValue]="i.id">
          {{ i.nombre }}
          <span class="text-muted">
            (Stock: {{ i.stock ?? 0 }} {{ i.unidad_medida || i.unidadMedida || 'â€”' }})
          </span>
        </option>
      </select>
    </div>

    <div class="col-md-3">
      <label class="form-label">Cantidad usada</label>
      <input
        class="form-control"
        type="number"
        step="0.01"
        [(ngModel)]="nuevoInsumo.cantidad_usada"
        name="cantidad_usada"
        min="0.01"
      />
    </div>

    <div class="col-md-3 text-end">
      <button
        class="btn btn-success mt-3 w-100"
        type="button"
        (click)="agregarInsumo()"
      >
        â• Agregar
      </button>
    </div>
  </div>

  <!-- Tabla de insumos asociados -->
  <table class="table table-sm table-bordered shadow-sm text-center align-middle">
    <thead class="table-light">
      <tr>
        <th>Insumo</th>
        <th>Cantidad usada</th>
        <th>Stock actual</th>
        <th>Unidad</th>
        <th style="width: 80px">Acciones</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let r of insumosAsociados">
        <td>{{ r.nombre || r.nombre_insumo || '(Sin nombre)' }}</td>
        <td>{{ r.cantidad_usada | number: '1.2-2' }}</td>
        <td>
          <span
            [ngClass]="{
              'text-danger fw-semibold': r.stock <= 0,
              'text-success': r.stock > 0
            }"
          >
            {{ r.stock ?? 'â€”' }}
          </span>
        </td>
        <td>{{ r.unidad_medida || r.unidadMedida || 'â€”' }}</td>
        <td>
          <button
            class="btn btn-sm btn-outline-danger"
            (click)="eliminarInsumo(r)"
          >
            ğŸ—‘ï¸
          </button>
        </td>
      </tr>

      <tr *ngIf="!insumosAsociados.length">
        <td colspan="5" class="text-center text-muted py-3">
          Sin insumos asociados
        </td>
      </tr>
    </tbody>
  </table>
</div>

</div>
</div>


    <!--  Barra de bÃºsqueda -->
<div class="d-flex justify-content-between align-items-center mb-3">
  <div class="input-group w-50">
    <input
      type="text"
      class="form-control"
      placeholder="Buscar por nombre o descripciÃ³n..."
      [(ngModel)]="searchTerm"
      name="searchTerm"
      (keyup.enter)="buscar()"
    />
    <button class="btn btn-outline-primary" type="button" (click)="buscar()">
      ğŸ” Buscar
    </button>
    <button class="btn btn-outline-secondary" type="button" (click)="limpiarBusqueda()">
      âŒ Limpiar
    </button>
  </div>
</div>

    <!-- LISTADO DE TIPOS -->
    <div *ngIf="loading">Cargando...</div>
    <div class="table-responsive" *ngIf="!loading">
      <table class="table table-sm table-striped align-middle">
        <thead>
          <tr>
            <th>Nombre</th>
            <th>CategorÃ­a</th>
            <th>Perfil</th>
            <th>DescripciÃ³n</th>
            <th>Precio base</th>
            <th style="width: 160px">Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let r of pagedItems">
            <td>{{ r.nombre }}</td>

            <!--  Corregido: muestra categorÃ­a correctamente -->
            <td>{{ r.categoria?.nombre || r.categoria || 'â€”' }}</td>

            <!--  Corregido: muestra perfil correctamente -->
            <td>{{ r.perfilExamen?.nombre || r.perfil?.nombre || r.perfil || 'â€”' }}</td>

            <td>{{ r.descripcion }}</td>
            <td>Q{{ r.precio | number: '1.2-2' }}</td>
            <td>
              <button
                class="btn btn-sm btn-outline-primary me-1"
                (click)="edit(r)"
              >
                âœï¸ Editar
              </button>
              <button
                class="btn btn-sm btn-outline-danger"
                (click)="remove(r)"
              >
                ğŸ—‘ï¸ Eliminar
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
        <!--  Controles de paginaciÃ³n -->
    <div class="d-flex justify-content-between align-items-center mt-3">
      <div>
        PÃ¡gina {{ page }} de {{ totalPages }} 
        ({{ totalItems }} registros)
      </div>

      <div>
        <button class="btn btn-outline-primary btn-sm me-1"
                [disabled]="page === 1"
                (click)="changePage(page - 1)">
          â¬…ï¸ Anterior
        </button>

        <button class="btn btn-outline-primary btn-sm"
                [disabled]="page === totalPages"
                (click)="changePage(page + 1)">
          Siguiente â¡ï¸
        </button>
      </div>
    </div>

    <!--  evita falsos positivos del analizador -->
    <ng-container *ngIf="false">
      <app-parametros-tipo-examen></app-parametros-tipo-examen>
    </ng-container>
  </div>
</div>
